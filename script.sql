/** SCRIPT CREATION TABLE **/

DROP TABLE PARTICIPATES;
DROP TABLE EVENTS;
DROP TABLE USERS;

CREATE TABLE USERS (
  idUser varchar2(255),
  numberIdentification varchar2(255),
  lastname varchar2(255),
  firstname varchar2(255),
  address varchar2(255),
  phone varchar2(255),
  CONSTRAINT ADMIN18_PK_USERS PRIMARY KEY (idUser)
); 

CREATE TABLE EVENTS (
  idEvent varchar2(255),
  idUser varchar2(255),
  dateEvent varchar2(255),
  placeEvent varchar2(255),
  nameEvent varchar2(255),
  typeEvent varchar2(255),
  cost number(10),
  nbReservedScenes number(10),
  nbReservedBooth number(10),
  comments varchar2(255),
  CONSTRAINT ADMIN18_PK_EVENTS PRIMARY KEY (idEvent),
  CONSTRAINT ADMIN18_FK_EVENTS_USERS FOREIGN KEY (idUser)
  REFERENCES USERS (idUser)
);

CREATE TABLE PARTICIPATES (
  idEvent varchar2(255),
  idUser varchar2(255),
  dateRegistre varchar2(255),
  CONSTRAINT ADMIN18_PK_PARTICIPATES PRIMARY KEY (idEvent,idUser),
  CONSTRAINT ADMIN18_FK_PARTICIPATES_EVENTS FOREIGN KEY (idEvent)
  REFERENCES EVENTS(idEvent),
  CONSTRAINT ADMIN18_FK_PARTICIPATES_USERS FOREIGN KEY (idUser)
  REFERENCES USERS (idUser)
); 

DROP VIEW VUE_EVENTS;
CREATE VIEW VUE_EVENTS 
	AS SELECT idEvent,idUser,dateEvent,placeEvent,nameEvent,typeEvent 
	FROM EVENTS ;

/**  FIN SCRIPT CREATION TABLE  **/

/** SCRIPT CREATION ROLE **/
DROP ROLE ADMIN18_ROLE_ADMIN;
DROP ROLE ADMIN18_ROLE_COLLECTIVITY;
DROP ROLE ADMIN18_ROLE_ORGANIZER;
DROP ROLE ADMIN18_ROLE_PARTICIPATE;
CREATE ROLE ADMIN18_ROLE_ADMIN;
CREATE ROLE ADMIN18_ROLE_COLLECTIVITY;
CREATE ROLE ADMIN18_ROLE_ORGANIZER;
CREATE ROLE ADMIN18_ROLE_PARTICIPATE;
/** FIN SCRIPT CREATION ROLE **/


/** SCRIPT CREATION PRIVILEGE POUR LES ROLES **/
GRANT SELECT ON VUE_EVENTS TO ADMIN18_ROLE_COLLECTIVITY;
GRANT SELECT ON PARTICIPATES TO ADMIN18_ROLE_COLLECTIVITY;

GRANT ADMIN18_ROLE_COLLECTIVITY TO ADMIN18_ROLE_PARTICIPATE;
GRANT SELECT,UPDATE(lastname,firstname,address,phone) ON USERS TO ADMIN18_ROLE_PARTICIPATE;
GRANT INSERT,DELETE ON PARTICIPATES TO ADMIN18_ROLE_PARTICIPATE;

GRANT ADMIN18_ROLE_COLLECTIVITY TO ADMIN18_ROLE_ORGANIZER;
GRANT SELECT,UPDATE(lastname,firstname,address,phone) ON USERS TO ADMIN18_ROLE_ORGANIZER;
GRANT SELECT,UPDATE,INSERT,DELETE ON EVENTS TO ADMIN18_ROLE_ORGANIZER;
GRANT SELECT ON PARTICIPATES TO ADMIN18_ROLE_ORGANIZER;

GRANT SELECT,INSERT,UPDATE,DELETE ON USERS TO ADMIN18_ROLE_ADMIN;
GRANT SELECT,INSERT,UPDATE,DELETE ON EVENTS TO ADMIN18_ROLE_ADMIN;
GRANT SELECT,INSERT,UPDATE,DELETE ON VUE_EVENTS TO ADMIN18_ROLE_ADMIN;
/** FIN SCRIPT CREATION PRIVILEGE POUR LES ROLES **/

/**  SCRIPT JEU ESSAI **/
GRANT ADMIN18_ROLE_ADMIN TO USER1;
GRANT ADMIN18_ROLE_ORGANIZER TO USER2;
GRANT ADMIN18_ROLE_ORGANIZER TO USER3;
GRANT ADMIN18_ROLE_PARTICIPATE TO USER4;
GRANT ADMIN18_ROLE_PARTICIPATE TO USER5;
GRANT ADMIN18_ROLE_PARTICIPATE TO USER6;
GRANT ADMIN18_ROLE_COLLECTIVITY TO USER7;

COMMIT;
/** ADMIN18 **/
INSERT INTO USERS VALUES('USER1','E165787P','admin1','admin1','Nantes','1111111111');


/** USER1 **/
INSERT INTO ADMIN18.USERS VALUES('USER2','E658790V','organizer2','organizer2','Lyon','2222222222');
INSERT INTO ADMIN18.USERS VALUES('USER3','E348715H','organizer3','organizer3','Paris','3333333333');
INSERT INTO ADMIN18.USERS VALUES('USER4','E238150J','participate4','participate4','Nantes','4444444444');
INSERT INTO ADMIN18.USERS VALUES('USER5','E729478S','participate5','participate5','Nantes','5555555555');
INSERT INTO ADMIN18.USERS VALUES('USER6','E452394P','participate6','participate6','Paris','6666666666');
INSERT INTO ADMIN18.USERS VALUES('USER7','E347987R','collectivity7','collectivity7','Lyon','7777777777');
DELETE ADMIN18.USERS WHERE idUser = 'USER3';
UPDATE ADMIN18.USERS SET phone = '2345678901' WHERE idUser = 'USER3';

/** USER2 **/
/** a executer apres avoir mis en place l'application */
EXECUTE ADMIN18.set_user_ctx_pkg.set_user;
SELECT SYS_CONTEXT('USER_CTX','role') FROM DUAL;
SELECT * FROM ADMIN18.USERS;
UPDATE ADMIN18.USERS SET address = 'Nantes';
SELECT * FROM ADMIN18.USERS;
INSERT INTO ADMIN18.EVENTS VALUES('EVENT1','USER2','31/10/2019','NANTES','OctoberFest','Festif',120000,2,4,'Fête nantaise');
INSERT INTO ADMIN18.EVENTS VALUES('EVENT2','USER2','31/11/2019','LYON','DevFest','Culturel',40000,1,6,'Découverte des technologies');
UPDATE ADMIN18.EVENTS SET dateEvent = '22/10/2019' WHERE idEvent = 'EVENT1';
SELECT * FROM ADMIN18.EVENTS;
DELETE FROM ADMIN18.EVENTS WHERE idEvent = 'EVENT1';
SELECT * FROM ADMIN18.EVENTS;
SELECT * FROM ADMIN18.PARTICPATES;

/** USER3 **/
INSERT INTO ADMIN18.EVENTS VALUES('EVENT3','USER3','12/10/2019','PARIS','Soliday','Festif',24000,4,10,'Festival de musique');
INSERT INTO ADMIN18.EVENTS VALUES('EVENT4','USER3','23/10/2019','PARIS','Activiste','Culturel',240000,6,31,'Festival polyculturel');
INSERT INTO ADMIN18.EVENTS VALUES('EVENT5','USER3','15/10/2019','PARIS','CEO','Culturel',560000,23,54,'Festival de veille technologique');
INSERT INTO ADMIN18.EVENTS VALUES('EVENT6','USER3','25/10/2019','MARSEILLE','Tournoi de pétanque','Culturel/Sportif',50000,0,6,'Concour de pétanque');
INSERT INTO ADMIN18.EVENTS VALUES('EVENT7','USER3','04/11/2019','NANTES','Festival des plantes','Culturel/Exposition',6000,1,12,'Exposition de plante');
UPDATE ADMIN18.EVENTS SET dateEvent = '24/11/2019' WHERE idEvent = 'EVENT3';
SELECT * FROM ADMIN18.EVENTS;
DELETE FROM ADMIN18.EVENTS WHERE idEvent = 'EVENT2';
SELECT * FROM ADMIN18.EVENTS;
SELECT * FROM ADMIN18.PARTICPATES;

/** USER4 **/
SELECT * FROM ADMIN18.USERS;
UPDATE ADMIN18.USERS SET phone = '0909090909';
SELECT * FROM ADMIN18.USERS;
SELECT * FROM ADMIN18.VUE_EVENTS;
INSERT INTO ADMIN18.PARTICIPATES VALUES('EVENT2','USER4','07/10/2019');
INSERT INTO ADMIN18.PARTICIPATES VALUES('EVENT3','USER4','07/10/2019');
SELECT * FROM ADMIN18.PARTICIPATES;
DELETE FROM ADMIN18.PARTICIPATES WHERE idEvent = 'EVENT2';
SELECT * FROM ADMIN18.PARTICPATES;

/** USER5 **/
SELECT * FROM ADMIN18.USERS;
UPDATE ADMIN18.USERS SET phone = '0674355687';
SELECT * FROM ADMIN18.USERS;
SELECT * FROM ADMIN18.VUE_EVENTS;
INSERT INTO ADMIN18.PARTICIPATES VALUES('EVENT4','USER5','07/10/2019');
INSERT INTO ADMIN18.PARTICIPATES VALUES('EVENT3','USER5','07/10/2019');
SELECT * FROM ADMIN18.PARTICIPATES;
DELETE FROM ADMIN18.PARTICIPATES WHERE idEvent = 'EVENT4';
SELECT * FROM ADMIN18.PARTICPATES;

/** USER6 **/
SELECT * FROM ADMIN18.USERS;
UPDATE ADMIN18.USERS SET phone = '0909090909';
SELECT * FROM ADMIN18.USERS;
SELECT * FROM ADMIN18.VUE_EVENTS;
INSERT INTO ADMIN18.PARTICIPATES VALUES('EVENT5','USER6','07/10/2019');
INSERT INTO ADMIN18.PARTICIPATES VALUES('EVENT4','USER6','07/10/2019');
INSERT INTO ADMIN18.PARTICIPATES VALUES('EVENT3','USER6','07/10/2019');
SELECT * FROM ADMIN18.PARTICIPATES;
DELETE FROM ADMIN18.PARTICIPATES WHERE idEvent = 'EVENT4';
SELECT * FROM ADMIN18.PARTICPATES;

/** USER7 **/
SELECT * FROM ADMIN18.USERS;
SELECT * FROM ADMIN18.VUE_EVENTS;
SELECT * FROM ADMIN18.PARTICIPATES;

/**  FIN SCRIPT JEU ESSAI **/

/** SCRIPT CREATION CONTEXT APPLICATION **/
CREATE OR REPLACE CONTEXT USER_CTX USING set_user_ctx_pkg;
/

CREATE OR REPLACE PACKAGE set_user_ctx_pkg IS 
  PROCEDURE set_user;
END;
/

CREATE OR REPLACE PACKAGE BODY set_user_ctx_pkg IS
  PROCEDURE set_user IS
    myRole VARCHAR2(255);
  BEGIN 
    SELECT GRANTED_ROLE INTO myRole
    FROM DBA_ROLE_PRIVS
    WHERE GRANTEE = SYS_CONTEXT('USERENV','SESSION_USER')
    AND GRANTED_ROLE LIKE 'ADMIN18%';
    DBMS_SESSION.SET_CONTEXT('USER_CTX','role',myRole);
    DBMS_SESSION.SET_CONTEXT('USER_CTX','idUser',SYS_CONTEXT('USERENV','SESSION_USER'));
  END set_user;
END set_user_ctx_pkg;
/
/** **/
GRANT EXECUTE ON set_user_ctx_pkg TO USER1;
GRANT EXECUTE ON set_user_ctx_pkg TO USER2;
GRANT EXECUTE ON set_user_ctx_pkg TO USER3;
GRANT EXECUTE ON set_user_ctx_pkg TO USER4;
GRANT EXECUTE ON set_user_ctx_pkg TO USER5;
GRANT EXECUTE ON set_user_ctx_pkg TO USER6;
GRANT EXECUTE ON set_user_ctx_pkg TO USER7;
COMMIT;

/** POLICY*/
BEGIN
  DBMS_RLS.DROP_POLICY ('ADMIN18','USERS','users_policy');
  DBMS_RLS.ADD_POLICY (
  object_schema => 'ADMIN18',
  object_name => 'USERS',
  policy_name => 'users_policy',
  function_schema => 'ADMIN18',
  policy_function => 'auth_users',
  statement_types => 'select'
);
END;
/

/** VPD SELECT USER **/
CREATE OR REPLACE FUNCTION auth_users(schema_var IN VARCHAR2,table_var IN VARCHAR2)
RETURN VARCHAR2
IS
  role VARCHAR2(400);
  return_val VARCHAR2 (400);
BEGIN
  role := SYS_CONTEXT('USER_CTX','role');
  IF role = 'ADMIN18_ROLE_PARTICIPATES' OR role = 'ADMIN18_ROLE_ORGANIZER' THEN
    return_val := 'idUser=SYS_CONTEXT(''USER_CTX'',''idUser'')';
  ELSE
    return_val := '1=1';
  END IF;
  RETURN return_val;
END;
/

/* VPD par colonne*/
BEGIN
  DBMS_RLS.ADD_POLICY (
  object_schema => 'ADMIN18',
  object_name => 'USERS',
  policy_name => 'users_update_policy',
  function_schema => 'ADMIN18',
  policy_function => 'auth_users_update',
  statement_types => 'update',
  sec_relevant_cols=> 'lastname,firstname,address,phone'
);
END;
/

/** VPD SELECT USER **/
CREATE OR REPLACE FUNCTION auth_users_update(schema_var IN VARCHAR2,table_var IN VARCHAR2)
RETURN VARCHAR2
IS
  role VARCHAR2(400);
  return_val VARCHAR2 (400);
BEGIN
  role := SYS_CONTEXT('USER_CTX','role');
  IF role = 'ADMIN18_ROLE_PARTICIPATES' OR role = 'ADMIN18_ROLE_ORGANIZER' THEN
    return_val := 'idUser=SYS_CONTEXT(''USER_CTX'',''idUser'')';
  ELSE
    return_val := '1=1';
  END IF;
  RETURN return_val;
END;
/